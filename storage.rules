rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Helper: checks if user is logged in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: validates image file (type + size)
    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
             && request.resource.size < 5 * 1024 * 1024; // 5MB limit
    }

    // Helper: file was uploaded by the current user (via metadata)
    function isOwner() {
      return isSignedIn()
             && resource.metadata.userId == request.auth.uid;
    }

    // ----------------------------------------------------------------
    // 1. MARKETPLACE LISTING IMAGES
    // ----------------------------------------------------------------
    match /listings/{fileName} {
      allow read:          if true;
      allow create:        if isSignedIn() && isValidImage();
      allow delete, update: if isOwner();
    }

    // ----------------------------------------------------------------
    // 2. BOOK EXCHANGE IMAGES
    // FIX: This path was missing â€” caused storage/unauthorized on AddBookPage
    // ----------------------------------------------------------------
    match /books/{fileName} {
      allow read:          if true;
      allow create:        if isSignedIn() && isValidImage();
      allow delete, update: if isOwner();
    }

    // ----------------------------------------------------------------
    // 3. BUSINESS PROFILE IMAGES
    // ----------------------------------------------------------------
    match /businesses/{fileName} {
      allow read:          if true;
      allow create:        if isSignedIn() && isValidImage();
      allow delete, update: if isOwner();
    }

    // ----------------------------------------------------------------
    // 4. ADS / SERVICE REQUEST ASSETS
    // ----------------------------------------------------------------
    match /adsx_assets/{fileName} {
      allow read:          if true;
      allow create:        if isSignedIn() && isValidImage();
      allow delete, update: if isOwner();
    }

    // ----------------------------------------------------------------
    // 5. USER PROFILE PHOTOS
    // ----------------------------------------------------------------
    match /avatars/{userId}/{fileName} {
      allow read:   if true;
      allow create: if isSignedIn()
                    && request.auth.uid == userId
                    && isValidImage();
      allow delete, update: if isSignedIn() && request.auth.uid == userId;
    }
    // ----------------------------------------------------------------
// 6. LOST & FOUND ITEM PHOTOS
// ----------------------------------------------------------------
match /lostfound/{fileName} {
  allow read:           if true;
  allow create:         if isSignedIn() && isValidImage();
  allow delete, update: if isOwner();
}

    // ----------------------------------------------------------------
    // DEFAULT: deny everything else
    // ----------------------------------------------------------------
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
